name: Generate FPK Package and Update FnDepot

on:
  workflow_run:
    workflows: ["Build and Push Multi-Arch Image to Aliyun ACR and Docker Hub"]  # 监听第一个工作流
    types: [completed]

jobs:
  generate-and-update:
    # 仅当 tag 触发且第一个工作流成功时执行
    if: |
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'v') &&
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout mytool repo (at tagged commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Extract version from tag
        id: extract_version
        run: |
          TAG=${{ github.event.workflow_run.head_branch }}
          VERSION=${TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"

      - name: Create workspace directory
        run: mkdir -p /tmp/fnpack-workspace/files

      - name: Run fnpack-builder to generate .fpk
        run: |
          pwd
          ls -la ${{ github.workspace }}
          docker run --rm \
            -e VERSION=${{ env.VERSION }} \
            -v ${{ github.workspace }}/docker/fnfpk/toolsplus:/workspace/toolsplus \
            -v /tmp/fnpack-workspace/files:/workspace/files \
            chrplus/fnpack-builder:v1.2.0

      - name: Verify .fpk file
        run: |
          ls -la /tmp/fnpack-workspace/files/
          if [ ! -f /tmp/fnpack-workspace/files/toolsplus.fpk ]; then
            echo "❌ FPK file not found!"
            exit 1
          fi

      - name: Checkout FnDepot repository
        uses: actions/checkout@v4
        with:
          repository: upchr/FnDepot
          token: ${{ secrets.GH_PAT }}
          path: fnpack-repo

      - name: Copy .fpk to FnDepot toolsplus/ directory
        run: |
          mkdir -p fnpack-repo/toolsplus
          cp /tmp/fnpack-workspace/files/toolsplus.fpk fnpack-repo/toolsplus/

      - name: Update fnpack.json
        working-directory: fnpack-repo
        run: |
          UPDATE_LOG="便签、定时任务管理（v${{ env.VERSION }}）"
          jq --arg ver "${{ env.VERSION }}" \
             --arg log "$UPDATE_LOG" \
             '.toolsplus.version = $ver | 
              .toolsplus.history += { ("v" + $ver): $log }' \
             fnpack.json > fnpack.json.tmp && mv fnpack.json.tmp fnpack.json

#      - name: Commit and push to FnDepot
#        working-directory: fnpack-repo
#        run: |
#          git config --global user.name "github-actions[bot]"
#          git config --global user.email "github-actions[bot]@users.noreply.github.com"
#          git add .
#          git commit -m "chore(toolsplus): release v${{ env.VERSION }}"
#          git push

      # ====== Bark 通知 ======
      - name: Send Bark notification (success)
        if: success()
        run: |
          curl -X POST "https://api.day.app/${{ secrets.BARK_TOKEN }}" \
            -H 'Content-Type: application/json; charset=utf-8' \
            -d $'{
              "title": "✅ FPK 发布成功",
              "body": "Version: ${{ env.VERSION }}",
              "group": "ToolsPlus",
              "icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'
          curl -X POST "${{ secrets.WECHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d '{
              "msgtype": "news",
              "news": {
                "articles" : [
                  {
                    "title" : "ToolsPlus✅",
                    "description" : "FPK 发布成功\nV: ${{ env.VERSION }}",
                    "url" : "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "picurl" : "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  }
                ]}
            }'

      - name: Send Bark notification (failure)
        if: failure()
        run: |
          curl -X POST "https://api.day.app/${{ secrets.BARK_TOKEN }}" \
            -H 'Content-Type: application/json; charset=utf-8' \
            -d $'{
              "title": "❌ FPK 发布失败",
              "body": "Version: ${{ env.VERSION }}",
              "group": "ToolsPlus",
              "icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'
          curl -X POST "${{ secrets.WECHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d '{
              "msgtype": "news",
              "news": {
                "articles" : [
                  {
                    "title" : "ToolsPlus❌",
                    "description" : "FPK 发布失败\nV: ${{ env.TAG }}",
                    "url" : "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "picurl" : "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  }
                ]}
            }'
